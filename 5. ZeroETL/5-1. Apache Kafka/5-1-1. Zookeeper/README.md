# ZooKeeper

* Apache Kafka는 분산 시스템으로, 여러 브로커들이 협력하여 데이터 스트리밍 및 메시징 서비스를 제공함.  
* 이러한 분산 시스템에서는 **노드 간의 상태를 관리하고 조율(코디네이션)하는 것이 매우 중요**함.  
* 이를 위해 Apache Kafka는 **Zookeeper**를 사용하여 클러스터의 메타데이터를 관리하고 브로커 간의 조정을 수행함.

## Zookeeper의 역할

### 메타데이터 관리

* Kafka 클러스터의 구성 정보, 브로커의 메타데이터, 토픽 및 파티션 정보 등을 관리함. 
* 메타데이터는 **Zookeeper의 znode 트리 구조에 저장**됨.

### 브로커 조정

* 브로커가 클러스터에 조인하거나 떠날 때 이를 관리함.
* 새로운 브로커가 추가되거나 기존 브로커가 장애를 일으키면 Zookeeper는 이를 감지하고 필요한 조치를 취함.

### 파티션 리더 선출

* Kafka의 **파티션은 여러 브로커에 분산 저장**됨.
* 각 파티션에는 리더 브로커가 있어 데이터를 읽고 쓸 수 있음.
* Zookeeper는 **각 파티션의 리더를 선출**하고, 브로커 간의 리더 정보를 조율함.

### 컨슈머 오프셋 관리

* Kafka의 초기 버전에서는 소비자의 오프셋 정보를 Zookeeper에 저장했음.
* 최신 버전에서는 Kafka의 내부 토픽에 오프셋을 저장하지만, Zookeeper는 여전히 중요한 조정 역할을 함.

### 락, 동기화

* 클러스터에서 쓰기 연산이 빈번할 경우 클러스터 전체를 동기화를 통해, **데이터 불일치를 방지**.

## Zookeeper의 아키텍처

* Zookeeper는 분산 코디네이션 서비스로, **여러 노드로 구성된 클러스터 형태로 동작**함.  
* Zookeeper 클러스터는 **리더와 팔로워**로 구성.

### Leader

* 클러스터 내에서 하나의 리더 노드가 선택됨.
* 클라이언트 요청을 처리하고, 팔로워 노드들과 데이터를 동기화함.

### Follower

* 나머지 노드들은 팔로워로 동작함.
* 리더 노드의 결정을 따르고, 클라이언트 요청을 리더 노드에 전달함.

### Client

* 클라이언트는 Zookeeper 클러스터에 연결되어 데이터를 읽거나 쓰는 작업을 수행함.
* Kafka 브로커와 컨슈머는 Zookeeper 클라이언트로 동작함.

## Zookeeper Ensemble

* Zookeeper 앙상블(Zookeeper Ensemble)은 Zookeeper의 **고가용성과 신뢰성을 제공하는 클러스터 구성 방식**임.  
* 앙상블은 **여러 대의 Zookeeper 서버 노드로 구성**되어 있으며, 이 노드들은 서로 협력하여 클러스터의 일관성을 유지하고 장애에 대비함.  
* Zookeeper 앙상블은 **리더 선출, 데이터 동기화, 그리고 클라이언트 요청 처리 등을 통해 분산 시스템의 코디네이션 서비스를 제공**함.

### Zookeeper 앙상블 구성

* **리더(Leader)**
    * 앙상블 내에서 단 하나의 리더 노드가 존재함.
    * **리더 노드는 모든 쓰기 요청을 처리**하고, 다른 팔로워 노드들과 데이터를 동기화함.
    * 리더는 임기(election term) 동안 선출된 상태로 유지됨.

* **팔로워(Follower)**
    * 나머지 노드들은 팔로워로 동작함.
    * 팔로워는 **리더에게 데이터를 동기화 받고, 클라이언트(Producer, Consumer)의 읽기 요청을 처리**함.
    * 리더가 장애를 일으키면 새로운 리더를 선출하기 위해 참여함.

* **관찰자(Observer)**
    * 앙상블에 참여할 수 있는 추가 노드 유형임.
    * 관찰자는 쓰기 요청을 처리하지 않고 읽기 요청만 처리함.
    * 클러스터의 성능과 확장성을 높이기 위해 사용됨.

앙상블의 구성은 **홀수 개의 노드**로 설정하여 **과반수 투표**를 통해 리더를 선출하고 클러스터의 일관성을 유지함.  
**최소 3개의 노드로 구성**하는 것이 일반적이며, 노드 수가 많을수록 신뢰성과 고가용성이 증가함.

### Zookeeper 앙상블의 주요 특징

* **고가용성**
    * 리더-팔로워 구조를 통해 Zookeeper는 고가용성을 보장함.
    * 리더 노드가 장애를 일으키면 팔로워 노드 중 하나가 새로운 리더로 선출됨.

* **강력한 일관성**
    * 모든 **쓰기 요청은 리더 노드**를 통해 수행되며, 팔로워 노드들은 리더의 결정을 복제함.
    * 이러한 방식은 데이터의 강력한 **일관성을 보장**함.

* **과반수 투표(Quorum)**
    * **중요한 결정은 앙상블의 과반수 노드의 동의**를 받아야 함.
    * 이는 클러스터의 신뢰성과 일관성을 유지하는 데 중요한 역할을 함.

### Zookeeper 앙상블의 동작 과정

* **리더 선출**
    * Zookeeper 클러스터가 시작되면 노드들은 **서로 통신하여 리더를 선출**함.
    * 리더 선출 과정은 **과반수 투표**를 통해 이루어짐.

* **데이터 동기화**
    * 리더는 모든 쓰기 요청을 처리하고, **데이터를 팔로워 노드들에게 동기화**함.
    * 팔로워는 리더로부터 데이터를 받아 로컬에 저장함.

* **클라이언트 요청 처리**
    * 클라이언트의 읽기 요청은 **팔로워 노드에서도 처리**될 수 있음.
    * **쓰기 요청은 리더 노드에서 처리되며, 처리 후 팔로워 노드들에게 동기화**됨.

## Znode

Znode는 Zookeeper의 파일 시스템과 유사한 구조를 가지며, 데이터를 저장하고 관리하는 기본 단위임.

### 특징

* **계층적 네임스페이스**
    * Znode는 **디렉토리와 파일의 구조**를 가지며, **계층적으로 조직**됨.
    * 각 Znode는 **경로**를 가지고 있으며, 이 경로는 **트리 구조**를 통해 고유하게 식별됨.

* **데이터 저장**

    * 각 Znode는 **최대 1MB**의 데이터를 저장할 수 있음.
    * Znode에 저장된 데이터는 다른 Znode로부터 **독립적으로 관리**됨.

* **상태(Stat) 정보 저장**

    * Znode는 **메타데이터를 포함한 상태 정보를 저장**할 수 있음.
    * 상태 정보에는 버전 번호, 타임스탬프, 데이터 길이 등이 포함됨.
    * **Stat 예시**
        * **Version Number**: 데이터 업데이트시 계속 변경 됨.
        * **ACL(Action Control List)**: Znode에 접근하기 위한 권한 획득 메커니즘.
        * **Timestamp**: Znode 생성 시간, 생성후 경과된 시간, 업데이트 시간을 ms 단위로 저장.
        * **Data length**: ZooKeeper의 데이터 크기.

### 유형

* **Persistent Znode**

    * 기본 Znode 유형으로, 명시적으로 삭제하지 않는 한 **클라이언트 세션 종료 후에도 유지**됨.
    * 시스템의 **영구 상태를 저장**하는 데 사용됨.

* **Ephemeral Znode**

    * 클라이언트 세션이 종료되면 **자동으로 삭제되는 Znode**임.
    * **임시 데이터나 상태 정보를 저장**하는 데 사용됨.
    * 주로 리더 선출이나 임시 Lock 메커니즘에 사용됨.

* **Sequential Znode**

    * Znode를 생성할 때 순차적으로 번호가 매겨짐.
    * 순서가 중요한 작업에 사용됨.
    * Persistent 및 Ephemeral Znode와 결합하여 Sequential Znode를 만들 수 있음.

### Znode Architecture Diagram

/  
├── app1  
│   ├── config  
│   ├── workers  
│   │   ├── worker1  
│   │   └── worker2  
│   └── leader  
└── app2  
    ├── config  
    ├── workers  
    │   ├── worker1  
    │   └── worker2  
    └── leader  



## Zookeeper의 장점

### 강력한 일관성 보장

* Zookeeper는 분산 시스템에서 강력한 **일관성**을 보장함.
* 모든 노드가 동일한 상태를 유지하도록 함.

### 고가용성

* Zookeeper는 클러스터 내에서 **리더-팔로워 구조를 통해 고가용성을 제공**함.
* 리더 노드에 장애가 발생해도 팔로워 노드가 새로운 리더로 선출됨.

### 간편한 API

* Zookeeper는 간단한 API를 제공하여 분산 시스템의 코디네이션을 쉽게 수행할 수 있음.
* 다양한 언어에서 사용 가능한 클라이언트 라이브러리를 제공함.

## Zookeeper의 단점

### 설정 및 관리의 복잡성

* Zookeeper 클러스터를 설정하고 관리하는 것이 복잡할 수 있음.
* 클러스터의 크기와 구성에 따라 많은 설정이 필요함.

### 성능 제한

* Zookeeper는 일관성을 보장하기 위해 많은 오버헤드가 발생할 수 있음.
* 높은 쓰기 성능을 요구하는 애플리케이션에서는 병목이 될 수 있음.